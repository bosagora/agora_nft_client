<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BOA SPACE</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <script src="metamask-onboarding.bundle.js"></script>
</head>

<body>
<main class="container-fluid">
    <header>
        <h1 class="text-center">BOA SPACE: Agora NFT Marketplace DApp</h1>
    </header>
    <section>
        <div class="card" id="metamask_card">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <form>
                            <button id="metamask" type="button" class="btn btn-primary">Connect to Metamask</button>
                        </form>
                    </div>
                    <div class="col">
                        <p class="info-text alert-secondary">Network: <span id="network"
                                                                            class="info-text alert-primary"></span></p>
                    </div>
                    <div class="col">
                        <p class="info-text alert-secondary">ChainId: <span id="chain"></span></p>
                    </div>
                    <div class="col-6">
                        <p class="info-text alert-secondary">Account: <span id="account"></span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" id="login_card">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <form>
                            <div class="form-group">
                                <label for="serverUrl">BOA-SPACE-SERVER BASE URL:</label>
                                <select class="form-control" id="serverUrl">
                                    <option>http://localhost:4000/graphql</option>
                                    <option>https://api.testnet.boaspace.io/graphql</option>
                                </select>
                            </div>
                            <button id="login" type="button" class="btn btn-secondary">Login to BOA SPACE</button>
                        </form>
                    </div>
                    <div class="col">
                        <p class="info-text alert-secondary">Nonce: <span id="nonce"
                                                                          class="info-text alert-primary"></span>
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="info-text alert-secondary">Jwt: <span id="jwt"></span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" id="import_nft_card">
            <h4 class="card-header">Import NFT</h4>
            <div class="card-body">
                <div class="row">
                    <form>
                        <label for="token_id">Token id:</label>
                        <input type="text" id="token_id" size="120"
                               value="89697278701889901864060606526707955834850344146599935406839114475468283183154"><br><br>
                        <label for="asset_contract_shared_address">Asset Contract:</label>
                        <input type="text" id="asset_contract_shared_address" size="120"
                               value="0x2fddd0f488B767E8Dd42aE4E60f0685A2e15b1Fd">
                        <button id="import_nft_btn" type="button" class="btn btn-secondary">Import NFT</button>
                    </form>
                </div>
                <div class="row">
                    <p class="info-text alert-secondary">Imported asset: <span id="imported_nft"></span></p>
                </div>
            </div>
        </div>
        </div>
        <div class="card" id="create_asset_card">
            <h4 class="card-header">Create an Asset</h4>
            <div class="card-body">
                <div class="row">
                    <form enctype=”multipart/form-data”>
                        <label for="name">Name:</label>
                        <input type="text" id="name" value="NFT_1">
                        <label for="total">Total supply:</label>
                        <input type="number" id="total" value=100><br><br>
                        <label for="desc">Image:</label>
                        <input type="text" id="desc" size="32" value="NFT description">
                        <label for="file_upload">Desc:</label>
                        <input type="file" id="file_upload" name="image_file">
                        <button id="create_asset" type="button" class="btn btn-secondary">Create Asset</button>
                    </form>
                </div>
                <div class="row">
                    <p class="info-text alert-secondary">Stored asset: <span id="new_asset"></span></p>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    window.addEventListener('DOMContentLoaded', () => {
            const metamaskButton = document.getElementById('metamask')
            const loginButton = document.getElementById('login')
            const loginCard = document.getElementById('login_card')
            const onboarding = new MetaMaskOnboarding()
            const serverSelect = document.getElementById('serverUrl')
            const accountText = document.getElementById('account')
            const networkText = document.getElementById('network')
            const chainText = document.getElementById('chain')
            const nonceText = document.getElementById('nonce')
            const jwtText = document.getElementById('jwt')
            const newAssetText = document.getElementById('new_asset')
            const createAssetCard = document.getElementById('create_asset_card')
            const nameText = document.getElementById('name')
            const descText = document.getElementById('desc')
            const totalNumber = document.getElementById('total')
            const fileUpload = document.getElementById('file_upload')
            const createAssetButton = document.getElementById('create_asset')
            const importNftCard = document.getElementById('import_nft_card')
            const tokenIdText = document.getElementById('token_id')
            const assetContractSharedAddressText = document.getElementById('asset_contract_shared_address')
            const importedNftText = document.getElementById('imported_nft')
            const importNftButton = document.getElementById('import_nft_btn')
            let accounts
            let address
            let signature
            let nonce
            let jwt
            let url
            let messageToSign
            const signNonce = async (nonce) => {
                messageToSign = "BOA SPACE: proof of account ownership by signing personal one time use nonce of " + nonce
                console.log("messageToSign = " + messageToSign)
                const web3 = new Web3(window.ethereum)
                await web3.eth.personal.sign(messageToSign, address)
                    .catch(e => console.error('signNonce:' + e.message))
                    .then(sig => {
                        console.log("Signature = " + sig)
                        signature = sig
                    })
            }
            const fetchJwt = async () => {
                try {
                    console.log("fetchJwt: calling", url, " for address", address, " message '" + messageToSign
                        + "' and signature " + signature)
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({query: `{ getJwt(address: "` + address + `", message:"` + messageToSign + `", signature: "` + signature + `") }`})
                    })
                    const res = await response.json();
                    jwt = res.data.getJwt.toString();
                    jwtText.innerText = jwt
                    console.log("jwt = " + jwt)
                } catch (e) {
                    console.error("fetchJwt error:" + e)
                    return e;
                }
            }

            function enableCreateAsset() {
                createAssetCard.hidden = false
                createAssetButton.onclick = async () => {
                    try {
                        console.log("createUserAsset: calling", url, " for address", address)
                        const formData = new FormData()
                        formData.append("operations", JSON.stringify({
                            operationName: "addAsset",
                            variables: {
                                name: nameText.value,
                                description: descText.value,
                                owner_address: address,
                                total_supply: parseInt(totalNumber.value),
                            },
                            query:
                                `mutation addAsset(
                                    $image_file: Upload!,
                                    $name: String!,
                                    $description: String!,
                                    $owner_address: String!,
                                    $total_supply: Int!)
                                { addAsset(
                                    image_file: $image_file,
                                    name: $name,
                                    description: $description,
                                    owner_address: $owner_address,
                                    total_supply: $total_supply) {
                                success
                                message
                                asset { id name description image_url token_id owner_address asset_contract_address total_supply } } }`
                        }))
                        formData.append("map", JSON.stringify({
                            "image_file": ["variables.image_file"]
                        }))
                        formData.append("image_file", fileUpload.files[0])
                        const filename = fileUpload.files[0]
                        console.log("image_file:", filename)
                        const response = await fetch(url, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Apollo-Require-Preflight': 'true',
                                'Authorization': 'Bearer ' + jwt
                            }
                        })
                        const res = await response.json()
                        console.log("addAsset response =", JSON.stringify(res.data.addAsset))
                        const newAsset = JSON.stringify(res.data.addAsset.asset, null, "  ")
                        console.log(JSON.stringify(newAsset))
                        newAssetText.innerText = newAsset
                    } catch (e) {
                        console.error("enableCreateAsset error:" + e)
                        return e;
                    }
                }
            }

            function enableImportNFT() {
                importNftCard.hidden = false
                importNftButton.onclick = async () => {
                    try {
                        console.log("enableImportNFT: calling", url, " for address", address)
                        const response = await fetch(url, {
                            method: 'POST',
                            body: JSON.stringify({
                                operationName: "importNft",
                                variables: {
                                    token_id: tokenIdText.value,
                                    contract: assetContractSharedAddressText.value,
                                },
                                query:
                                    `mutation importNft(
                                    $token_id: String!,
                                    $contract: String!)
                                { importNft(
                                    token_id: $token_id,
                                    contract: $contract) {
                                success
                                message
                                asset { id name description image_url token_id owner_address asset_contract_address total_supply } } }`
                            }),

                            headers: {
                                'Content-Type': 'application/json',
                                'Apollo-Require-Preflight': 'true',
                                'Authorization': 'Bearer ' + jwt
                            }
                        })
                        const res = await response.json();
                        importedNftText.innerText = JSON.stringify(res.data.importNft, null, " ")
                        console.log("imported nft = " + importedNftText.innerText)
                    } catch (e) {
                        console.error("import NFT error:" + e)
                        return e;
                    }
                }
            }

            function enableLogin() {
                loginCard.hidden = false
                loginButton.onclick = async () => {
                    url = serverSelect.options[serverSelect.selectedIndex].text
                    console.log("enableLogin: calling", url, " for address", address)
                    await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({query: `{ getNonce(address: "${address}") }`})
                    }).catch(e => console.error('fetchNonce:' + e.message))
                        .then(res => res.json())
                        .then(res => {
                            nonce = res.data.getNonce.toString()
                            console.log('loginButton.onclick: nonce = ' + nonce)
                            nonceText.innerText = nonce
                        })
                        .then(() => signNonce(nonce))
                        .then(() => fetchJwt())
                        .then(() => enableImportNFT())
                        .then(() => enableCreateAsset())
                }
            }

            const updateChainIdText = async () => {
                await window.ethereum.request({
                    method: 'eth_chainId'
                })
                    .catch(e => console.error(e.message))
                    .then((chainId) => {
                        chainText.innerText = chainId.toString()
                        if (chainId === "0x867") {
                            networkText.innerText = "Agora Mainnet (2151)"
                        } else if (chainId === "0x7e3") {
                            networkText.innerText = "Agora Testnet (2019)"
                        } else {
                            networkText.innerText = "Unknown network"
                        }
                    })
            }
            const getCoinbase = async () => {
                await window.ethereum.request({
                    method: 'eth_coinbase'
                })
                    .catch(e => console.error(e.message))
                    .then(coinbase => {
                        console.log("coinbase = " + coinbase)
                        address = coinbase
                        console.log("address = " + address)
                        accountText.innerText = address
                    })
            }

            function updateButton() {
                loginCard.hidden = true
                createAssetCard.hidden = true
                importNftCard.hidden = true
                if (!MetaMaskOnboarding.isMetaMaskInstalled()) {
                    metamaskButton.innerText = 'Click here to install MetaMask!'
                    metamaskButton.onclick = () => {
                        metamaskButton.innerText = 'Onboarding in progress'
                        metamaskButton.disabled = true
                        onboarding.startOnboarding()
                    }
                } else if (accounts && accounts.length > 0) {
                    metamaskButton.innerText = 'Connected to Metamask'
                    metamaskButton.disabled = true
                    onboarding.stopOnboarding()
                    getCoinbase()
                    updateChainIdText()
                    enableLogin()
                } else {
                    metamaskButton.innerText = 'Connect to Metamask'
                    metamaskButton.onclick = async () => {
                        await window.ethereum.request({
                            method: 'eth_requestAccounts'
                        })
                            .catch(e => console.error(e.message))
                            .then(res => {
                                console.log("res = " + res)
                                accounts = res
                                updateButton()
                            })
                    }
                }
            }

            updateButton()
            if (MetaMaskOnboarding.isMetaMaskInstalled()) {
                window.ethereum.on('accountsChanged', (newAccounts) => {
                    accounts = newAccounts
                    updateButton()
                })
                window.ethereum.on('chainChanged', (chainId) => {
                    alert("Reload due to chainId change to " + chainId)
                    window.location.reload()
                })
            }
        }
    )
</script>
</body>

</html>
