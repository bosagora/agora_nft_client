<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BOA SPACE</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <script src="metamask-onboarding.bundle.js"></script>
</head>

<body>
<main class="container-fluid">
    <header>
        <h1 class="text-center">BOA SPACE: Agora NFT Marketplace DApp</h1>
    </header>
    <section>
        <div class="card" id="metamask_card">
            <form>
                <h4 class="card-header">
                    <button id="metamask" type="button" class="btn btn-primary">Connect to Metamask</button>
                </h4>
            </form>
            <div class="card-body">
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <p class="info-text alert-secondary">Network: <span id="network"
                                                                            class="info-text alert-primary"></span></p>
                    </div>
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <p class="info-text alert-secondary">ChainId: <span id="chain"></span></p>
                    </div>
                    <div class="col-xl-8 col-lg-12 col-md-24 col-sm-24 col-24">
                        <p class="info-text alert-secondary">Account: <span id="account"></span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" id="login_card">
            <div class="card-body">
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <form>
                            <div class="form-group">
                                <label for="serverUrl">BOA-SPACE-SERVER BASE URL:</label>
                                <select class="form-control" id="serverUrl">
                                    <option>http://localhost:4000/graphql</option>
                                    <option>https://api.testnet.boaspace.io/graphql</option>
                                </select>
                            </div>
                            <button id="login" type="button" class="btn btn-secondary">Login to BOA SPACE</button>
                        </form>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <p class="info-text alert-secondary">Nonce: <span id="nonce"
                                                                          class="info-text alert-primary"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <p class="info-text alert-secondary">Jwt: <span id="jwt"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-12 col-sm-12 col-12">
                        <p class="info-text alert-secondary">My assets: <span id="assets"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const metamaskButton = document.getElementById('metamask')
        const loginButton = document.getElementById('login')
        const loginCard = document.getElementById('login_card')
        const onboarding = new MetaMaskOnboarding()
        const serverSelect = document.getElementById('serverUrl')
        const accountText = document.getElementById('account')
        const networkText = document.getElementById('network')
        const chainText = document.getElementById('chain')
        const nonceText = document.getElementById('nonce')
        const jwtText = document.getElementById('jwt')
        const myAssetsText = document.getElementById('assets')
        let accounts
        let address
        let signature
        let nonce
        let jwt
        let myAssets
        let url
        let messageToSign
        const signNonce = async (nonce) => {
            messageToSign = "BOA SPACE: proof of account ownership by signing personal one time use nonce of " + nonce
            console.log("messageToSign = " + messageToSign)
            const web3 = new Web3(window.ethereum)
            await web3.eth.personal.sign(messageToSign, address)
                .catch(e => console.error('signNonce:' + e.message))
                .then(sig => {
                    console.log("Signature = " + sig)
                    signature = sig
                })
        }
        const fetchJwt = async () => {
            try {
                console.log("fetchJwt: calling", url, " for address", address, " message '" + messageToSign
                    + "' and signature " + signature)
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: `{ getJwt(address: "` + address + `", message:"` + messageToSign + `", signature: "` + signature + `") }`})
                })
                const res = await response.json();
                jwt = res.data.getJwt.toString();
                jwtText.innerText = jwt
                console.log("jwt = " + jwt)
            } catch (e) {
                console.error("fetchJwt error:" + e)
                return e;
            }
        }
        const createUserAsset = async () => {
            try {
                console.log("createUserAsset: calling", url, " for address", address)
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + jwt
                    },
                    body: JSON.stringify({mutation: `{ createAsset(address: "` + address + `")` +
                            `{ token_id, image_url, description, owner_address } }`})
                })
                const res = await response.json()
                myAssets = JSON.stringify(res.data.getMyAssets, null, "  ")
                console.log("assets =", myAssets)
                myAssetsText.innerText = myAssets
            } catch (e) {
                console.error("getUserAssets error:" + e)
                return e;
            }
        }
        const getUserAssets = async () => {
            try {
                console.log("getUserAssets: calling", url, " for address", address)
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + jwt
                    },
                    body: JSON.stringify({query: `{ getMyAssets(address: "` + address + `")` +
                        `{ token_id, image_url, description, owner_address } }`})
                })
                const res = await response.json()
                myAssets = JSON.stringify(res.data.getMyAssets, null, "  ")
                console.log("assets =", myAssets)
                myAssetsText.innerText = myAssets
            } catch (e) {
                console.error("getUserAssets error:" + e)
                return e;
            }
        }

        function enableLogin() {
            loginCard.hidden = false
            loginButton.onclick = async () => {
                url = serverSelect.options[serverSelect.selectedIndex].text
                console.log("enableLogin: calling", url, " for address", address)
                await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: `{ getNonce(address: "` + address + `") }`})
                }).catch(e => console.error('fetchNonce:' + e.message))
                    .then(res => res.json())
                    .then(res => {
                        nonce = res.data.getNonce.toString()
                        console.log('loginButton.onclick: nonce = ' + nonce)
                        nonceText.innerText = nonce
                    })
                    .then(() => signNonce(nonce))
                    .then(() => fetchJwt())
                    .then(() => getUserAssets())
            }
        }

        const updateChainIdText = async () => {
            await window.ethereum.request({
                method: 'eth_chainId'
            })
                .catch(e => console.error(e.message))
                .then((chainId) => {
                    chainText.innerText = chainId.toString()
                    if (chainId === "0x867") {
                        networkText.innerText = "Agora Mainnet (2151)"
                    } else if (chainId === "0x7e3") {
                        networkText.innerText = "Agora Testnet (2019)"
                    } else {
                        networkText.innerText = "Unknown network"
                    }
                })
        }
        const getCoinbase = async () => {
            await window.ethereum.request({
                method: 'eth_coinbase'
            })
                .catch(e => console.error(e.message))
                .then(coinbase => {
                    console.log("coinbase = " + coinbase)
                    address = coinbase
                    console.log("address = " + address)
                    accountText.innerText = address
                })
        }

        function updateButton() {
            loginCard.hidden = true
            if (!MetaMaskOnboarding.isMetaMaskInstalled()) {
                metamaskButton.innerText = 'Click here to install MetaMask!'
                metamaskButton.onclick = () => {
                    metamaskButton.innerText = 'Onboarding in progress'
                    metamaskButton.disabled = true
                    onboarding.startOnboarding()
                }
            } else if (accounts && accounts.length > 0) {
                metamaskButton.innerText = 'Connected to Metamask'
                metamaskButton.disabled = true
                onboarding.stopOnboarding()
                getCoinbase()
                updateChainIdText()
                enableLogin()
            } else {
                metamaskButton.innerText = 'Connect to Metamask'
                metamaskButton.onclick = async () => {
                    await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    })
                        .catch(e => console.error(e.message))
                        .then(res => {
                            console.log("res = " + res)
                            accounts = res
                            updateButton()
                        })
                }
            }
        }

        updateButton()
        if (MetaMaskOnboarding.isMetaMaskInstalled()) {
            window.ethereum.on('accountsChanged', (newAccounts) => {
                accounts = newAccounts
                updateButton()
            })
            window.ethereum.on('chainChanged', (chainId) => {
                alert("Reload due to chainId change to " + chainId)
                window.location.reload()
            })
        }
    })
</script>
</body>

</html>
